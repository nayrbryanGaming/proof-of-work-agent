name: POW Agent Loop

on:
  # Run every 30 minutes
  schedule:
    - cron: "*/30 * * * *"
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  run-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd pow-agent
          pip install -r requirements.txt

      - name: Run POW Agent Cycle
        env:
          COLOSSEUM_API_KEY: ${{ secrets.COLOSSEUM_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          AGENTWALLET_SESSION: ${{ secrets.AGENTWALLET_SESSION }}
          PROGRAM_ID: ${{ secrets.PROGRAM_ID }}
          SOLANA_RPC: https://api.devnet.solana.com
          GITHUB_ACTIONS: "true"
        run: |
          cd pow-agent
          python -c "
import asyncio
import sys
sys.path.insert(0, '.')

from agent.loop import run_cycle, get_solana_client
from colosseum.api import ColosseumAPI
from agent.logger import get_logger

async def main():
    log = get_logger('github-actions')
    log.info('=== POW Agent Cycle Started (GitHub Actions) ===')
    
    try:
        api = ColosseumAPI()
        solana = get_solana_client()
        
        result = await run_cycle(api, solana, cycle_num=0)
        
        log.info(f'Cycle completed in {result.duration:.2f}s')
        log.info(f'  Heartbeat: {result.heartbeat_synced}')
        log.info(f'  Forum: {result.forum_engaged}')
        log.info(f'  Task solved: {result.task_solved}')
        log.info(f'  Hash: {result.task_hash[:16] if result.task_hash else \"N/A\"}...')
        
        if result.errors:
            for err in result.errors:
                log.warn(f'  Error: {err}')
        
        log.info('=== POW Agent Cycle Complete ===')
        return 0
        
    except Exception as e:
        log.error(f'Cycle failed: {e}')
        return 1

sys.exit(asyncio.run(main()))
"

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agent-logs-${{ github.run_number }}
          path: pow-agent/logs/
          retention-days: 7
