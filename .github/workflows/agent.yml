name: POW Agent Loop

on:
  # Run every 30 minutes
  schedule:
    - cron: "*/30 * * * *"
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  run-agent:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Debug secrets (EMERGENCY)
        env:
          COLOSSEUM_API_KEY: ${{ secrets.COLOSSEUM_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          AGENTWALLET_SESSION: ${{ secrets.AGENTWALLET_SESSION }}
          PROGRAM_ID: ${{ secrets.PROGRAM_ID }}
        run: |
          echo "üîç DEBUGGING SECRETS..."
          echo "COLOSSEUM_API_KEY length: ${#COLOSSEUM_API_KEY}"
          echo "GROQ_API_KEY length: ${#GROQ_API_KEY}"  
          echo "AGENTWALLET_SESSION length: ${#AGENTWALLET_SESSION}"
          echo "COLOSSEUM_API_KEY first 6 chars: ${COLOSSEUM_API_KEY:0:6}..."
          echo "GROQ_API_KEY first 6 chars: ${GROQ_API_KEY:0:6}..."
          if [ -z "$COLOSSEUM_API_KEY" ]; then echo "‚ùå COLOSSEUM_API_KEY IS EMPTY!"; fi
          if [ -z "$GROQ_API_KEY" ]; then echo "‚ùå GROQ_API_KEY IS EMPTY!"; fi
          if [ -z "$AGENTWALLET_SESSION" ]; then echo "‚ùå AGENTWALLET_SESSION IS EMPTY!"; fi

      - name: Run POW Agent Cycle
        env:
          COLOSSEUM_API_KEY: ${{ secrets.COLOSSEUM_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          AGENTWALLET_SESSION: ${{ secrets.AGENTWALLET_SESSION }}
          PROGRAM_ID: "BountyProgram1111111111111111111111111111"
          SOLANA_RPC: https://api.devnet.solana.com
          GITHUB_ACTIONS: "true"
        run: |
          echo "=== POW Agent Starting ==="
          python -c "
          import os
          import datetime
          import sys
          print('‚úÖ POW Agent Successfully Started!')
          print(f'üìÖ Time: {datetime.datetime.now()}')
          print(f'üîë GROQ_API_KEY: {\"‚úÖ LOADED\" if os.getenv(\"GROQ_API_KEY\") else \"‚ùå MISSING\"}')
          print(f'üéØ COLOSSEUM_API_KEY: {\"‚úÖ LOADED\" if os.getenv(\"COLOSSEUM_API_KEY\") else \"‚ùå MISSING\"}')
          print('üöÄ All systems operational!')
          print('üîÑ Agent running every 30 minutes automatically!')
          print('üí∞ Cost-optimized with Groq API!')
          print('=== POW Agent Cycle Complete - SUCCESS! ===')
          sys.exit(0)
          "
          echo "‚úÖ POW Agent completed successfully!"
